/*! visual-sedimentation 2015-12-09 */
!function(a){a.fn.vs=function(){},a.fn._vs={},a.fn._vs.token={},a.fn._vs.draw={},a.fn._vs.stream={},a.fn._vs.chart={},a.fn._vs.phy={},a.fn._vs.decay={},a.fn._vs.flocculate={},a.fn._vs.strata={},a.fn._vs.aggregate={};var b=function(b,c){function d(a,b){var c={};for(var d in a)c[d]=a[d];for(var d in b)c[d]=b[d];return c}function e(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}this.token=a.fn._vs.token,this.draw=a.fn._vs.draw,this.stream=a.fn._vs.stream,this.chart=a.fn._vs.chart,this.phy=a.fn._vs.phy,this.decay=a.fn._vs.decay,this.flocculate=a.fn._vs.flocculate,this.strata=a.fn._vs.strata,this.mouse={},this.mouse.x=0,this.mouse.y=0,this.mouse.isMouseDragging=!1,this.mouse.isMouseDown=!1,this.mouse.selectedBody=null,this.dataFlow=[],this.chartPhySetup={},this.tokens=[],this.world=null,this.ctx=null;var f,g=(a(b),this),h={x:0,y:0,width:290.5,height:300.5,DOMelement:null,chart:{x:void 0,y:void 0,width:void 0,height:void 0,colorRange:d3.scale.category10(),scale:d3.scale,type:"StackedAreaChart",spacer:5,column:3,wallColor:"rgba(230,230,230,0)",label:!0,radius:10},data:{model:[{label:"Column A"},{label:"Column B"},{label:"Column C"}],strata:[[{initValue:100,label:"Strata 1 col A"}],[{initValue:20,label:"Strata 1 col B"}],[{initValue:175,label:"Strata 2 col C"}]],token:[{timestamp:1,category:1,value:1,userdata:{},callback:{}}],tokenPast:0,stream:{provider:"generator",refresh:1250,now:0}},sedimentation:{token:{size:{original:4,minimum:2},visible:!0},incoming:{strategy:1,point:[{x:50,y:0},{x:100,y:0},{x:150,y:0}],target:[{x:50,y:0},{x:100,y:0},{x:150,y:0}]},granulate:{visible:!1},flocculate:{number:1,action:"buffer",strategy:"Size",bufferSize:5,bufferTime:1e3,bufferHeight:50,bufferFrameRate:25,buffer:[]},suspension:{height:null,incomming:"top",decay:{power:1.001},refresh:200},accumulation:{height:null},aggregation:{height:0,maxData:0,invertStrata:!1}},options:{refresh:40,panel:!1,scale:30,layout:!1,canvasFirst:!0}};this.now=function(){return(new Date).getTime()},this.globalDecay=function(a){return"undefined"==typeof a?this.settings.sedimentation.suspension.decay.power:this.settings.sedimentation.suspension.decay.power=a},this.getWorld=function(){return this.world},this.chartUpdate=function(a,b){var c={cat:a,y:b};this.chart[this.settings.chart.type](g,"update",c)},this.flocculateTokens=function(a){return this.flocculate.update(g,a)},this.flocculateAll=function(){return this.flocculate.all(g)},this.addToken=function(a){return this.token.addToken(g,a)},this.selectAll=function(a,b){return this.token.selectAll(g,a,b)},this.select=function(a,b){return this.token.select(g,a,b)},this.updateAll=function(a){var b=this.chart.updateAll(g,key,value);return b},this.update=function(a,b){var c=this.chart.update(g,a,b);return c},d(h,c),void 0!=c.data&&(h.data=c.data),this.settings=a.extend(!0,h,c),this.settings.DOMelement=b,"undefined"==typeof this.settings.chart.width&&(this.settings.chart.width=this.settings.width),"undefined"==typeof this.settings.chart.x&&(this.settings.chart.x=0),"undefined"==typeof this.settings.chart.y&&(this.settings.chart.y=0),"undefined"==typeof this.settings.chart.height&&(this.settings.chart.height=this.settings.height),"undefined"==typeof this.settings.stream&&(this.settings.stream={}),"undefined"==typeof this.settings.stream.now&&(this.settings.stream.now=0),"undefined"==typeof this.settings.stream.provider&&(this.settings.stream.provider="generator"),"undefined"==typeof this.settings.stream.refresh&&(this.settings.stream.refresh=1e3),"undefined"==typeof this.settings.data.tokenPast&&(this.settings.data.tokenPast=0),"undefined"==typeof this.settings.data.tokens&&(this.settings.data.tokens=[]),"undefined"!=typeof this.settings.data.strata&&0!=this.settings.data.strata.length&&("undefined"==typeof this.settings.sedimentation.aggregation&&(this.settings.sedimentation.aggregation={}),"undefined"==typeof this.settings.sedimentation.aggregation.height&&(this.settings.sedimentation.aggregation.height=this.settings.chart.height/2),"undefined"==typeof this.settings.sedimentation.aggregation.maxData&&(this.settings.sedimentation.aggregation.maxData=10)),this.init=function(){function a(a,b,c){return b.mouse.selectedToken=a,a.GetBody().GetType()!=b.phy.b2Body.b2_staticBody&&a.GetShape().TestPoint(a.GetBody().GetTransform(),c)?(b.mouse.selectedToken=a,!1):!0}function c(a,b){var c=b.getBodyAtMouse(b);if(null!==c&&"undefined"!=typeof c.m_userData&&"undefined"!=typeof c.m_userData.callback){if("function"==typeof c.m_userData.callback.mouseover){var d=b.select("ID",c.m_userData.ID);c.m_userData.callback.mouseover(d)}if("function"==typeof c.m_userData.callback.mouseout){var e,d=b.select("ID",c.m_userData.ID),f=function(){var a=d,f=b,g=c;return function(){var b=f.getBodyAtMouse(f),c=!1;c=null!==b&&"undefined"!=typeof b.m_userData&&b.m_userData.ID==a.attr("ID")?!1:!0,c&&(g.m_userData.callback.mouseout(a),clearInterval(e))}};e=window.setInterval(f(),100)}}}function d(a,b){b.mouse.isMouseDown=!0,b.handleMouseMove(a,b);var c=b.getBodyAtMouse(b);if(null!==c&&"undefined"!=typeof c.m_userData&&"undefined"!=typeof c.m_userData.callback&&"function"==typeof c.m_userData.callback.onclick){var d=b.select("ID",c.m_userData.ID);c.m_userData.callback.onclick(d)}}function e(a,b){b.mouse.isMouseDown=!1}function h(a,b){b.mouse.isMouseDown?(b.mouse.isMouseDragging=!0,b.mouse.x=a.clientX,b.mouse.y=a.clientY):(b.handleMouseMove(a,b),c("move",b))}this.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}(),this.world=new this.phy.b2World(new this.phy.b2Vec2(0,0),!0);var k=b.appendChild(document.createElement("div"));k.id="box_sediviz_"+j(),k.width=this.settings.width,k.height=this.settings.height,this.settings.DOMelement=k,f=k.appendChild(document.createElement("canvas")),f.id="canvas",f.width=this.settings.width,f.height=this.settings.height,f.style.position="absolute",this.ctx=f.getContext("2d"),this.chart[this.settings.chart.type](g,"init"),this.stream.init(g),this.flocculate.init(g),this.stream.update(g),this.token.init(g),this.strata.init(this),window.setInterval(function(){g.update(g)},g.settings.options.refresh/2),window.setInterval(function(){g.draw.update(g)},g.settings.options.refresh),window.setInterval(function(){g.decay.update(g)},g.settings.sedimentation.suspension.refresh),g.strata.update(g),this.getBodyAtMouse=function(b){var c=b.mouse.x/b.settings.options.scale,d=b.mouse.y/b.settings.options.scale,e=new b.phy.b2Vec2(c,d),f=new b.phy.b2AABB,g=.001;return f.lowerBound.Set(c-g,d-g),f.upperBound.Set(c+g,d+g),b.mouse.selectedToken=null,b.world.QueryAABB(function(c){return a(c,b,e)},f),b.mouse.selectedToken},this.handleMouseMove=function(a,b){canvasPosition=i(b.settings.DOMelement),b.mouse.x=a.clientX-(canvasPosition.offsetLeft-this.getScrollPosition()[0]),b.mouse.y=a.clientY-(canvasPosition.offsetTop-this.getScrollPosition()[1])},this.getScrollPosition=function(){return Array(document.documentElement&&document.documentElement.scrollLeft||window.pageXOffset||g.pageXOffset||document.body.scrollLeft,document.documentElement&&document.documentElement.scrollTop||window.pageYOffset||g.pageYOffset||document.body.scrollTop)},document.addEventListener("mousemove",function(a){h(a,g)}),document.addEventListener("mouseup",function(a){e(a,g)}),document.addEventListener("mousedown",function(a){d(a,g)})},this.mouse.update=function(a){if(isMouseDown&&!mouseJoint){var b=getBodyAtMouse();if(b){var c=new b2MouseJointDef;c.bodyA=world.GetGroundBody(),c.bodyB=b,c.target.Set(mouseX,mouseY),c.collideConnected=!0,c.maxForce=300*b.GetMass(),mouseJoint=world.CreateJoint(c),b.SetAwake(!0)}}mouseJoint&&(isMouseDown?mouseJoint.SetTarget(new b2Vec2(mouseX,mouseY)):(world.DestroyJoint(mouseJoint),mouseJoint=null))},this.update=function(a){this.world.Step(1/60,10,10),this.world.DrawDebugData(),this.world.ClearForces()};var i=function(a){for(var b=a.offsetTop,c=a.offsetLeft;a=a.offsetParent;)b+=a.offsetTop,c+=a.offsetLeft;return{offsetLeft:c,offsetTop:b}},j=function(){var a=function(){return Math.floor(65536*Math.random()).toString(16)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()};this.utile={},this.utile.GUID=j,this.utile.clone=e,this.settings=a.extend(this.settings,{}||{}),this.init()};a.fn.vs=function(c){if(!arguments.length)var c={};return this.each(function(){var d=a(this);if(!d.data("VisualSedimentation")){var e=new b(this,c);d.data("visualSedimentation",e)}})}}(jQuery),function(a){a.fn._vs.phy={b2Vec2:Box2D.Common.Math.b2Vec2,b2AABB:Box2D.Collision.b2AABB,b2BodyDef:Box2D.Dynamics.b2BodyDef,b2Body:Box2D.Dynamics.b2Body,b2FixtureDef:Box2D.Dynamics.b2FixtureDef,b2Fixture:Box2D.Dynamics.b2Fixture,b2World:Box2D.Dynamics.b2World,b2MassData:Box2D.Collision.Shapes.b2MassData,b2PolygonShape:Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape:Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw:Box2D.Dynamics.b2DebugDraw,b2MouseJointDef:Box2D.Dynamics.Joints.b2MouseJointDef,b2Shape:Box2D.Collision.Shapes.b2Shape,b2DistanceJointDef:Box2D.Dynamics.Joints.b2DistanceJointDef,b2RevoluteJointDef:Box2D.Dynamics.Joints.b2RevoluteJointDef,b2Joint:Box2D.Dynamics.Joints.b2Joint,b2PrismaticJointDef:Box2D.Dynamics.Joints.b2PrismaticJointDef,b2ContactListener:Box2D.Dynamics.b2ContactListener,b2Settings:Box2D.Common.b2Settings}}(jQuery),function(a){a.fn.vs.chart={}}(jQuery),function(a){a.fn._vs.draw={settings:{draw:{trail:1,showLayout:!1}},update:function(a){1==this.settings.draw.trail?a.ctx.clearRect(0,0,a.ctx.canvas.clientWidth,a.ctx.canvas.clientHeight):debugDrawChart(0,0,ctx.canvas.clientWidth,ctx.canvas.clientHeight,"rgba(255,255,255,"+this.settings.draw.trail+")",ctx);for(var b=a.world.GetBodyList();b;b=b.GetNext())for(var c=b.GetFixtureList();null!=c;c=c.GetNext())this.drawShape(a,c);1==this.settings.draw.showLayout&&this.debugDrawChart(chart.position.x,chart.position.y,chart.position.width,chart.position.height,"rgba(255,0,0,0.2)",ctx)},debugDrawChart:function(a,b,c,d,e,f){f.save(),f.translate(0,0),f.fillStyle=e,f.beginPath(),f.rect(a,b,c,d),f.closePath(),f.strokeStyle="#000",f.lineWidth=.5,f.stroke(),f.restore()},showTexture:function(a,b){"undefined"!=typeof a.m_userData.texture&&"undefined"!=typeof a.m_userData.texture.pattern&&(b.fillStyle=a.m_userData.texture.pattern,b.fill())},drawShape:function(a,b){var c=b.GetBody(),d=c.GetPosition(),e=c.GetAngle(),f=9,g=10,h=a.settings.options.scale;if(b.m_userData.x=c.GetWorldCenter().x*h,b.m_userData.y=c.GetWorldCenter().y*h,"undefined"!=typeof b)switch(b.GetType()){case 0:switch(b.m_userData){case null:a.ctx.fillStyle="rgba(255,0,0,1)";break;default:a.ctx.fillStyle=b.m_userData.fillStyle}var i=b.m_shape.m_radius;if(1==a.settings.sedimentation.token.visible){a.ctx.save(),a.ctx.translate(d.x*h,d.y*h),a.ctx.rotate(e),a.ctx.beginPath();var j=i/g*f*h;"undefined"!=typeof b.m_userData.strokeStyle?a.ctx.strokeStyle=b.m_userData.strokeStyle:a.ctx.strokeStyle="rgba(0,0,0,0)","undefined"!=typeof b.m_userData.lineWidth?a.ctx.lineWidth=b.m_userData.lineWidth:a.ctx.lineWidth=0,a.ctx.arc(0,0,j,0,2*Math.PI,!0),a.ctx.closePath(),1==a.settings.options.layout?(a.ctx.strokeStyle="#000",a.ctx.lineWidth=.5,a.ctx.stroke()):(a.ctx.fill(),a.ctx.stroke(),this.showTexture(b,a.ctx)),a.ctx.restore()}break;case 1:switch(b.m_userData){case null:a.ctx.fillStyle="rgba(255,0,0,1)";break;default:a.ctx.fillStyle=b.m_userData.fillStyle}b.m_shape.m_vertices[0].x*h,b.m_shape.m_vertices[0].y*h,d.x*h-b.m_shape.m_vertices[0].x*h,d.y*h-b.m_shape.m_vertices[0].y*h;a.ctx.save(),a.ctx.translate(d.x*h,d.y*h),a.ctx.rotate(e),a.ctx.beginPath(),"undefined"!=typeof b.m_userData.strokeStyle?a.ctx.strokeStyle=b.m_userData.strokeStyle:a.ctx.strokeStyle=b.m_userData.fillStyle,"undefined"!=typeof b.m_userData.lineWidth?a.ctx.lineWidth=b.m_userData.lineWidth:a.ctx.lineWidth=0;for(var k=0;k<b.m_shape.m_vertices.length;k++){var l=b.m_shape.m_vertices;a.ctx.moveTo(l[0].x*h,l[0].y*h);for(var m=1;m<l.length;m++)a.ctx.lineTo(l[m].x*h,l[m].y*h);a.ctx.lineTo(l[0].x*h,l[0].y*h)}a.ctx.closePath(),a.ctx.fill(),this.showTexture(b,a.ctx),1==a.settings.options.layout?(a.ctx.lineWidth=.25,a.ctx.strokeStyle="rgb(0,0,0)",a.ctx.stroke()):a.ctx.stroke(),a.ctx.restore();break;case 2:}if("undefined"!=typeof b.m_userData.callback&&"function"==typeof b.m_userData.callback.draw){var n=a.select("ID",b.m_userData.ID);b.m_userData.callback.draw(n)}}}}(jQuery),function(a){a.fn._vs.token={colorRange:function(){},init:function(a){this.colorRange=a.settings.chart.colorRange},ID:function(a){return a.settings.data.tokenPast+=1,a.settings.data.tokenPast},selectAll:function(a,b,c){var d=[],e=!1;d.flocculate=function(){var a=[];return d.forEach(function(b){q=b.flocculate(),a.push(q)}),a},d.attr=function(a,b,c){var e=[];return d.forEach(function(d){q=d.attr(a,b,c),e.push(q)}),e},d.b2dObj=function(a,b,c){var e=[];return d.forEach(function(a){q=a.myobj,e.push(q)}),e},"undefined"==typeof c&&"undefined"==typeof b&&(e=!0);for(var f=a.tokens.length-1;f>=0;f--)(a.tokens[f].attr(b)==c||1==e)&&d.push(a.tokens[f]);return d},select:function(a,b,c){if(result=[],"undefined"==typeof c&&"undefined"==typeof b)return a.tokens;for(var d=a.tokens.length-1;d>=0;d--)if(a.tokens[d].attr(b)==c){result.push(a.tokens[d]);break}return"undefined"==typeof result[0]?!1:result[0]},addToken:function(a,b){var c={x:50,y:50,t:null,category:1,state:0,size:10,fillStyle:"###",strokeStyle:"rgba(0,0,0,0)",lineWidth:0,texture:void 0,shape:{type:"round"},userdata:{},callback:{},phy:{density:10,friction:0,restitution:0},targets:[],elbow:{}},d={};if(d.toString=function(){return"Token ID="+this.setting.ID},"undefined"==typeof b?(d.setting=c,d.setting.ID=this.ID(a)):(d.setting=b,"undefined"==typeof d.setting.phy&&(d.setting.phy=c.phy),"undefined"==typeof d.setting.t&&(d.setting.t=a.settings.stream.now),"undefined"==typeof d.setting.x&&(d.setting.x=a.settings.sedimentation.incoming.point[b.category].x+2*Math.random()),"undefined"==typeof d.setting.y&&(d.setting.y=a.settings.sedimentation.incoming.point[b.category].y+2*Math.random()),"undefined"==typeof d.setting.size&&(d.setting.size=a.settings.sedimentation.token.size.original),"undefined"==typeof d.setting.targets&&(d.setting.targets=[]),d.setting.ID=d.setting.ID=this.ID(a),"undefined"==typeof d.setting.state&&(d.setting.state=0),"undefined"==typeof d.setting.shape&&(d.setting.shape=c.shape)),d.myobj=this.create(a,d.setting),d.flocculate=function(){return a.tokens.indexOf(this),a.flocculate.destroyIt(a,this),this},d.attr=function(a,b,c){return"undefined"==typeof b?"undefined"!=typeof this[a]?this[a]():this.myobj.m_userData[a]:("undefined"!=typeof this[a]?this[a](b,c):this.myobj.m_userData[a]=b,this)},d.callback=function(a,b){return arguments.length?"function"==typeof this.myobj.m_userData.callback[a]?this.myobj.m_userData.callback[a](b):function(a){console.log("callback undefined")}:this.myobj.m_userData.callback},d.size=function(a){if(null!=this.myobj&&this.attr("state")<2){if(!arguments.length)return this.myobj.m_shape.m_radius*this.myobj.m_userData.scale;this.myobj.m_shape.m_radius=a/this.myobj.m_userData.scale}},d.b2dObj=function(){return null!=this.myobj&&this.attr("state")<2?this.myobj:void 0},d.texture=function(a){if(!arguments.length)return this.myobj.m_userData.texture.img.src;console.log("texture",a);var b={};b.img=new Image,b.img.onload=function(){b.pattern=document.createElement("canvas").getContext("2d").createPattern(b.img,"repeat")},b.img.src=a,this.myobj.m_userData.texture=b},a.tokens.push(d),a.decay.tokens.push(d),"undefined"!=typeof this.myobj.m_userData.callback&&"function"==typeof this.myobj.m_userData.callback.suspension){var e=a.select("ID",d.setting.ID);this.myobj.m_userData.callback.suspension(e)}return d},create:function(a,b){b.scale=scale=a.settings.options.scale;var c=b.x/scale+.1*Math.random(),d=b.y/scale+.1*Math.random(),e=new Box2D.Dynamics.b2FixtureDef;e.density=.1,e.friction=0,e.restitution=0,"round"==b.shape.type?e.shape=new Box2D.Collision.Shapes.b2CircleShape(b.size/scale):"polygons"==b.shape.type?e=this.setPolygons(a,b,e):"box"==b.shape.type&&(e.shape=new Box2D.Collision.Shapes.b2PolygonShape,e.shape.SetAsBox(b.shape.width/scale,b.shape.height/scale));var f=new Box2D.Dynamics.b2BodyDef;if(f.type=Box2D.Dynamics.b2Body.b2_dynamicBody,f.position.x=b.x/scale,f.position.y=b.y/scale,this.myobj=a.world.CreateBody(f).CreateFixture(e),"undefined"!=typeof b.texture){var g=b.texture;g.img=new Image,g.img.onload=function(){g.pattern=document.createElement("canvas").getContext("2d").createPattern(g.img,"repeat")},g.img.src=g.src}if("undefined"!=typeof b.impulse&&this.applyImpulse(this.myobj,b.impulse.angle,b.impulse.power),"undefined"==typeof b.fillStyle&&(b.fillStyle=this.colorRange(b.category)),"undefined"==typeof b.lineWidth&&(b.lineWidth=0),"undefined"==typeof b.type&&(b.type="token"),"undefined"==typeof b.callback&&(b.callback={}),this.myobj.m_userData=b,this.myobj.attr=this.attr,this.myobj.m_userData.mouse={},this.myobj.m_userData.mouse.over=!1,this.myobj.m_userData.mouse.down=!1,this.myobj.m_userData.mouse.dragging=!1,this.myobj.m_userData.mouse.statebefore=!1,this.myobj.m_userData.state=1,0==b.targets.length&&"CircleLayout"==a.settings.chart.type&&(b.targets[0]={x:a.settings.sedimentation.incoming.target[b.category].x,y:a.settings.sedimentation.incoming.target[b.category].y}),b.targets.length>0){var h=new a.phy.b2MouseJointDef;h.bodyA=a.world.GetGroundBody(),h.bodyB=this.myobj.GetBody(),h.target.Set(c,d),h.collideConnected=!0,h.maxForce=50*this.myobj.GetBody().GetMass(),mouseJoint=a.world.CreateJoint(h),mouseJoint.SetTarget(new a.phy.b2Vec2(b.targets[0].x/scale,b.targets[0].y/scale))}return this.myobj},applyImpulse:function(a,b,c){var d=a.GetBody();d.ApplyImpulse(new Box2D.Common.Math.b2Vec2(Math.cos(b*(Math.PI/180))*c,Math.sin(b*(Math.PI/180))*c),d.GetWorldCenter())},setPolygons:function(a,b,c){c.shape=new Box2D.Collision.Shapes.b2PolygonShape,null==b.shape.points&&(b.shape.points=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:-1},{x:1,y:-1}]);for(var d=0;d<b.shape.points.length;d++){var e=new Box2D.Common.Math.b2Vec2;e.Set(b.shape.points[d].x/scale,b.shape.points[d].y/scale),b.shape.points[d]=e}return c.shape.SetAsArray(b.shape.points,b.shape.points.length),c},createDataBarBall:function(a,b,c,d,e){var f=new Box2D.Dynamics.b2FixtureDef;f.density=10,f.friction=.5,f.restitution=.2,f.shape=new Box2D.Collision.Shapes.b2CircleShape(d/a.settings.options.scale);var g=new Box2D.Dynamics.b2BodyDef;g.type=Box2D.Dynamics.b2Body.b2_dynamicBody,g.position.x=b/a.settings.options.scale,g.position.y=c/a.settings.options.scale;var h=a.world.CreateBody(g).CreateFixture(f);return h.m_userData={type:"BarChartBall",familyID:"family",fillColor:this.colorRange(e)},h},createBox:function(a,b,c,d,e,f,g,h){"undefined"==typeof h&&(h=!0);var i=new b2FixtureDef;h||(i.density=100),i.friction=.6,i.restitution=.3;var j=new b2BodyDef;j.type=b2Body.b2_staticBody,j.angle=f,i.shape=new b2PolygonShape,i.shape.SetAsBox(d/scale,e/scale),j.position.Set(b/scale,c/scale);var k=a.CreateBody(j).CreateFixture(i);return k.m_userData={type:"Wall",fillColor:g},console.log(k.m_userData),k},createBoxPie:function(a,b,c,d,e,f,g,h){var i=new b2BodyDef;i.type=Box2D.Dynamics.b2Body.b2_dynamicBody;var j=new Box2D.Dynamics.b2FixtureDef;j.shape=new b2PolygonShape,j.shape.SetAsBox(e/scale,f/scale),j.density=1e6,j.friction=.5,j.restitution=.2,i.position.Set(c/scale,d/scale),i.angle=0;var k=a.CreateBody(i).CreateFixture(j);return k.m_userData={type:"Wall",fillColor:h},k},createBox0D:function(a,b,c,d,e,f){"undefined"==typeof f&&(f=!0);var g=new b2BoxDef;g.restitution=-.6,g.friction=.3,f||(g.density=.01),g.extents.Set(d,e);var h=new b2BodyDef;return h.AddShape(g),h.position.Set(b,c),a.CreateBody(h)},createHiddenBox:function(a,b,c,d,e,f){"undefined"==typeof f&&(f=!0);var g=new b2BoxDef;g.restitution=.6,g.friction=.3,f||(g.density=1),g.extents.Set(d,e);var h=new b2BodyDef;h.AddShape(g),h.position.Set(b,c);var i=a.CreateBody(h);return i.m_shapeList.visibility="hidden",console.log(i),i},createBigBall:function(a,b,c){var d=new Box2D.Dynamics.b2FixtureDef;d.density=1e6,d.friction=.5,d.restitution=.2,d.shape=new Box2D.Collision.Shapes.b2CircleShape(20/30);var e=new Box2D.Dynamics.b2BodyDef;e.type=Box2D.Dynamics.b2Body.b2_dynamicBody,e.position.x=b,e.position.y=c;var f=a.CreateBody(e).CreateFixture(d);return f},createPieBox:function(b,c,d,e,f,g,h,i){i=a.extend(!0,{density:1e7,friction:1,restitution:.2,linearDamping:0,angularDamping:0,gravityScale:0,type:b2Body.b2_dynamicBody},i);var j=new b2BodyDef,k=new b2FixtureDef;k.density=i.density,k.friction=i.friction,k.restitution=i.restitution,k.shape=new b2PolygonShape,k.shape.SetAsBox(e/scale,f/scale),j.position.Set(c/scale,d/scale),j.linearDamping=i.linearDamping,j.angularDamping=i.angularDamping,j.angle=g,j.type=i.type;var l=b.CreateBody(j),m=l.CreateFixture(k);return m.m_userData={type:"box",familyID:null,fillColor:h},l},createDataBallTarget:function(a,b,c,d,e,f,g){var h=d/scale+.1*Math.random(),i=e/scale+.1*Math.random(),j=new Box2D.Dynamics.b2FixtureDef;j.density=.1,j.friction=0,j.restitution=0,j.shape=new Box2D.Collision.Shapes.b2CircleShape(f/scale);var k=new Box2D.Dynamics.b2BodyDef;k.type=Box2D.Dynamics.b2Body.b2_dynamicBody,k.position.x=h,k.position.y=i;var l=a.CreateBody(k).CreateFixture(j),m=new b2MouseJointDef;return m.bodyA=a.GetGroundBody(),m.bodyB=l.GetBody(),m.target.Set(h,i),m.collideConnected=!0,m.maxForce=50*l.GetBody().GetMass(),mouseJoint=a.CreateJoint(m),mouseJoint.SetTarget(new b2Vec2(b/scale,c/scale)),l.m_userData={type:"PieBall",familyID:g,fillColor:colorScale(g)},categorys[g].value+=1,categorys[g].joins.push(mouseJoint),l},createDataBallPie:function(a,b,c,d,e,f){console.log(b);var g=categorys[f].incomingPoint.x/scale+2*Math.random()/scale,h=categorys[f].incomingPoint.y/scale,i=new Box2D.Dynamics.b2FixtureDef;i.density=.1,i.friction=0,i.restitution=0,i.shape=new Box2D.Collision.Shapes.b2CircleShape(e/scale);var j=new Box2D.Dynamics.b2BodyDef;j.type=Box2D.Dynamics.b2Body.b2_dynamicBody,j.position.x=g,j.position.y=h;var k=a.CreateBody(j);k.m_userData={type:"PieBall",familyID:f,fillColor:categorys[f].color},listBodies.push(k);var l=k.CreateFixture(i),m=new b2MouseJointDef;return m.bodyA=a.GetGroundBody(),m.bodyB=l.GetBody(),m.target.Set(g,h),m.collideConnected=!0,m.maxForce=100*l.GetBody().GetMass(),mouseJoint=a.CreateJoint(m),mouseJoint.SetTarget(new b2Vec2(b.position.x/scale,b.position.y/scale)),l.m_userData={type:"PieBall",familyID:f,fillColor:colorScale(f)},categorys[f].value+=1,l},createDataBall:function(a,b,c,d){var e=new Box2D.Dynamics.b2FixtureDef;e.density=1,e.friction=.5,e.restitution=.2,e.shape=new Box2D.Collision.Shapes.b2CircleShape(d/a.settings.options.scale);var f=new Box2D.Dynamics.b2BodyDef;f.type=Box2D.Dynamics.b2Body.b2_dynamicBody,f.position.x=b,f.position.y=c;var g=a.world.CreateBody(f).CreateFixture(e);return g.m_userData={type:"PieBall",familyID:"family",fillColor:"rgb(200,0,0)"},g}}}(jQuery),function(a){a.fn._vs.stream={i:null,buffer:[],speed:1e4/6,strategy:null,type:null,init:function(a){this.speed=a.settings.data.stream.refresh,type=a.settings.data.stream.provider},push:function(a){console.log(a);for(var b=a.length-1;b>=0;b--)buffer.push(a)},update:function(a){if("generator"==type)for(var b=0;b<a.settings.data.model.length;b++)a.dataFlow[b]=setInterval(function(a,b){return function(){b.settings.data.stream.now++;var c=b.chart[b.settings.chart.type](b,"token",a);b.addToken(c)}}(b,a),this.speed);else"tokens"==type&&(a.dataFlow[0]=setInterval(function(a,b){return function(){b.settings.data.stream.now++;for(var a=0;a<b.settings.data.tokens.length;a++)b.settings.data.tokens[a].t==b.settings.data.stream.now&&b.addToken(b.settings.data.tokens[a])}}(b,a),this.speed))},generator:function(a,b){},test:function(a){a.tokens.push(a.token.createDataBarBall(a,a.settings.sedimentation.incoming[i].x+2*Math.random(),a.settings.sedimentation.incoming[i].y+1*Math.random(),a.settings.sedimentation.token.size,i))},setSpeed:function(a,b){speedFlow=b;for(var c=0;c<categorys.length;c++)window.clearInterval(dataFlow[c]);window.clearInterval(decayFlow),dataFlow(categorys)}}}(jQuery),function(a){a.fn._vs.decay={tokens:[],update:function(a){var b=(a.settings.sedimentation.suspension.height,a.settings.height,a.settings.sedimentation.token.size/4,a.settings.sedimentation.suspension.decay.power),c=(a.settings.options.scale,a.settings.sedimentation.token.size.minimum);if(null==b)var b=0;for(var d=0;d<this.tokens.length;d++){var e=this.tokens[d].attr("size");0!=b&&this.tokens[d].attr("size",e/b),c>=e&&null!=a.settings.sedimentation.flocculate.strategy&&(a.flocculate.destroyIt(a,this.tokens[d]),a.strata.update(a))}}}}(jQuery),function($){$.fn._vs.strata={stratas:[],init:function(_this){function fstrata(){for(var a=Array(),b=0;b<mySettings.data.model.length;b++)a.push(fstratum(b));return a}function fstratum(a){for(var b=Array(NB_STRATA),c=0;c<b.length;c++)b[c]=Array();if("undefined"!=typeof _this)for(var d=_this.selectAll("category",s).attr("state").filter(function(a){return 2==a?a:void 0}).length,e=0;e<d.length;e++)for(var f=d[e],c=0;c<b.length;c++)f<_this.settings.stream.now-2*c&&f>=_this.settings.stream.now-2*(c+1)&&b[b.length-c-1].push(f);for(var g=Array(),h=0;NB_STRATA>h;h++){var i=b[h].length;!function(b){g.push({value:function(){return b},label:"Strata "+h,category:a})}(i)}return g}if("StackedAreaChart"!=_this.settings.chart.type)return void _this.strata.create_strata(_this);if(settings=_this.settings,"function"!=typeof settings.data.strata&&("undefined"==typeof settings.data.strata||0==settings.data.strata.length)){for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,value:function(a,b){return 0}};_this.strata.stratas[i]=[defaultStrata]}return void _this.strata.create_strata(_this)}if("function"!=typeof settings.data.strata){if("undefined"!=typeof settings.data.strata[0]&&"undefined"!=typeof settings.data.strata[0][0].value){for(var NB_STRATA=settings.data.strata[0].length,i=0;i<settings.data.model.length;i++){_this.strata.stratas[i]=[];for(var n=0;NB_STRATA>n;n++)!function(a,b){var t=null;"undefined"!=typeof settings.data.strata[a]&&"undefined"!=typeof settings.data.strata[a][b]&&"undefined"!=typeof settings.data.strata[a][b].texture&&(t=settings.data.strata[a][b].texture);var defaultStrata={};defaultStrata={label:settings.data.model[i].label+"_"+a,category:a,texture:t,value:function(){return r=eval("f="+settings.data.strata[a][b].value),r()}},_this.strata.stratas[a].push(defaultStrata)}(i,n)}return void _this.strata.create_strata(_this)}if("undefined"!=typeof settings.data.strata[0]&&"undefined"!=typeof settings.data.strata[0][0]){for(var c=0;c<settings.data.model.length;c++){var defaultStrata={label:settings.data.model[c].label+"_"+c,category:i,value:function(a,b){return a.selectAll("category",b)?settings.data.strata[b][0].initValue+a.selectAll("category",b).attr("state").filter(function(a){return 2==a?a:void 0}).length:settings.data.strata[b][0].initValue}};_this.strata.stratas[c]=[defaultStrata]}return void _this.strata.create_strata(_this)}if(0==settings.data.strata[0].length){for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,value:function(a,b){return a.selectAll("category",b)?a.selectAll("category",b).attr("state").filter(function(a){return 2==a?a:void 0}).length:0}};_this.strata.stratas[i]=[defaultStrata]}return void _this.strata.create_strata(_this)}var NB_STRATA=settings.data.strata[0].length;return settings.data.strata_param=settings.data.strata,_this.settings.data.strata=function(){return fstrata()},_this.strata.stratas=_this.settings.data.strata(),void _this.strata.create_strata(_this)}if("function"==typeof settings.data.strata||settings.data.strata[0].length>0||_this.strata.stratas.length>0){if("function"==typeof settings.data.strata||settings.data.strata[0].length>0&&"object"==typeof settings.data.strata[0])if("function"==typeof settings.data.strata)_this.strata.stratas=settings.data.strata();else if("function"==typeof settings.data.strata[0].value)for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,initValue:settings.data.model[i].value,value:function(a,b){return settings.data.strata[i]}};_this.strata.stratas[i]=[defaultStrata]}else for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,initValue:settings.data.model[i].value,value:function(a,b){return"undefined"==typeof a.selectAll("category",b).length?this.initValue:a.selectAll("category",b)?this.initValue+a.selectAll("category",b).attr("state").filter(function(a){return 2==a?a:void 0}).length:0}};_this.strata.stratas[i]=[defaultStrata]}_this.strata.create_strata(_this)}},selectAll:function(a,b,c){if(result=[],result.attr=function(a,b,c){var d=[];return result.forEach(function(e){q=e.attr(a,b,c),d.push(q)}),d},"undefined"==typeof c&&"undefined"==typeof b)return this.stratas;for(var d=a.strata.stratas.length-1;d>=0;d--)if(a.strata.stratas[d].attr(b)==c){result.push(a.strata.stratas[d]);break}return"undefined"==typeof result[0]?!1:result[0]},add:function(a,b){var c=function(){};return c.myobj=b,c.attr=function(a,b,c){return"undefined"==typeof b?"undefined"!=typeof this[a]?this[a]():this.myobj[a]:("undefined"!=typeof this[a]?this[a](b,c):this.myobj[a]=b,this)},c},remove:function(a,b,c){},strata_layers:function(a,b,c,d){function e(a,b){return{x:b,y:Math.max(0,a)}}var f=d3.scale.linear().domain([1,c-2]).range([Math.PI/2,2*Math.PI-Math.PI/2]);d3.scale.pow().exponent(10).domain([0,c]).range([0,1]);return d3.range(b).map(function(b){var g=5*Math.random();return d3.range(c).map(function(c){if("sin"==a.settings.sedimentation.aggregation.strataType){if(1==b)return 20;var e=5+5*g*Math.sin(f(c))+50*b;return 0>e?-e:e}return"log"==a.settings.sedimentation.aggregation.strataType?b+1:("undefined"==typeof d&&(d=0),a.strata.stratas[d][b].value(a,d))}).map(e)})},create_strata:function(a){if("StackedAreaChart"==a.settings.chart.type){var b=a.settings.chart.width/a.settings.data.model.length,c=a.settings.sedimentation.aggregation.height,d=a.token.colorRange;if("undefined"!=typeof a.settings.options.canvasFirst&&0==a.settings.options.canvasFirst)var e=d3.select("#"+a.settings.DOMelement.id).insert("div",":first-child").style("position","absolute").attr("class","vis").style("z-index",10).append("svg").attr("width",a.settings.width).attr("height",a.settings.height).append("g").attr("transform","translate("+a.settings.chart.x+","+a.settings.chart.y+")");else var e=d3.select("#"+a.settings.DOMelement.id).append("div").attr("class","vis").style("z-index",10).append("svg").attr("width",a.settings.width).attr("height",a.settings.height).append("g").attr("transform","translate("+a.settings.chart.x+","+a.settings.chart.y+")");var f=(a.strata.stratas[0].length,20);smx=f-1,smy=0;var g=a.strata.stratas.map(function(b,c){for(var d=0,e=0;d<b.length;d++)e+=b[d].value(a,c);return e}),h=d3.scale.linear().domain([0,Math.max(d3.max(g),a.settings.sedimentation.aggregation.maxData)]).range([0,a.settings.sedimentation.aggregation.height]),i=e.selectAll("g.gcol").data(a.strata.stratas,function(a){return[a]}).enter().append("g").attr("transform",function(c,d){var e=a.settings.sedimentation.aggregation.height;return a.settings.sedimentation.aggregation.invertStrata&&(e=2*a.settings.sedimentation.aggregation.height-h(g[d])),"translate("+d*b+", "+(a.settings.chart.height-e)+")"}).attr("class",function(a,b){return"gcol col_"+b}),j=i.selectAll(".gpath").data(function(b,c){var d=d3.layout.stack().offset("expand")(a.strata.strata_layers(a,b.length,f,c));return smy=d3.max(d,function(a){return d3.max(a,function(a){return a.y0+a.y})}),d.map(function(a){
a.map(function(a){return a.col=c,a})}),d}).enter().append("g").attr("class","gpath"),k=d3.svg.area().x(function(c){return a.settings.chart.spacer+c.x*(b-2*a.settings.chart.spacer)/smx}).y0(function(a){return c-a.y0*a.offshit}).y1(function(a){return c-(a.y+a.y0)*a.offshit}),l=j.append("path").attr("d",function(b,d){return a.chartUpdate(d,-h(g[d])-(c-a.settings.chart.height)),hh=0,b.map(function(a){return a.offshit=hh,a}),k(b)});l.style("fill",function(b,c){return null!=a.strata.stratas[b[0].col][c].texture?"url(#RectanglePattern_"+b[0].col+"_"+c+")":d3.rgb(d(b[0].col)).darker(a.strata.stratas[b[0].col].length/2-(c+1)/2)}).attr("class",function(a,b){return"gcol col_"+a[0].col+" layer_"+b});var m=b/1,n=m;if("undefined"!=typeof a.settings.data.strata)for(var o=0;o<a.settings.data.strata.length;o++)for(var p=0;p<a.settings.data.strata[o].length;p++)if(null!=a.settings.data.strata[o][p].texture){var q=e.append("pattern").attr("id","RectanglePattern_"+o+"_"+p).attr("height",n).attr("width",m).attr("patternTransform","translate(0, 0) scale("+a.settings.data.strata[o][p].texture.size+", "+a.settings.data.strata[o][p].texture.size+") rotate(0)").attr("patternUnits","userSpaceOnUse");q.append("image").attr("x",0).attr("y",0).attr("height",n).attr("width",m).attr("xlink:href",function(){return a.settings.data.strata[o][p].texture.url})}}else if("CircleLayout"==a.settings.chart.type){var r=d3.select("#"+a.settings.DOMelement.id).append("div").attr("class","vis").attr("width",a.settings.width).attr("height",a.settings.height).append("svg").attr("width",a.settings.width).attr("height",a.settings.height);if("undefined"!=typeof a.settings.chart.treeLayout)for(var s=0;s<a.settings.data.model.length;s++){var t=a.settings.data.strata[s],d=function(b){return a.token.colorRange(s)};a.strata.create_pie_chart(a,t,r,t[0].value,d,(s+.5)*a.settings.chart.width/a.settings.data.model.length+a.settings.chart.x,a.settings.chart.y+a.settings.chart.height/6)}else{var t=a.settings.data.strata.map(function(a){return{value:a[0].value}}),d=a.token.colorRange;a.strata.create_pie_chart(a,t,r,a.settings.chart.radius,d,a.settings.chart.x+a.settings.chart.width/2,a.settings.chart.y+a.settings.chart.height/2)}}},create_pie_chart:function(a,b,c,d,e,f,g){var h=a.settings.width/a.settings.data.model.length,i=a.settings.sedimentation.aggregation.height;d3.scale.linear().domain([0,a.settings.data.strata.length-1]).range([0,a.settings.width]),d3.scale.linear().domain([0,d3.max(b,function(a){return a.value})]).rangeRound([0,i]),a.settings.width,a.settings.height,a.settings.sedimentation.aggregation.height;labelr=d+30,donut=d3.layout.pie().sort(null),arc=d3.svg.arc().innerRadius(0).outerRadius(d);var j=Math.random();c.append("g.arcs_"+j).attr("class","arcs_"+j);var k=c.selectAll(".arcs").data(donut(b.map(function(a,b){return a.value}))).enter().append("svg:g").attr("transform","translate("+f+","+g+")"),l=0;d3.svg.area().x(function(b){return a.settings.chart.spacer+b.x*(h-2*a.settings.chart.spacer)/smx}).y0(function(a){return i-a.y0*l}).y1(function(a){return i-(a.y+a.y0)*l}),k.append("path").attr("fill",function(a,b){return e(b)}).attr("d",function(a,b){return arc(a)}).each(function(a){this._current=a})},update:function(a){if("undefined"!=typeof a.strata.stratas&&0!=a.strata.stratas.length){"function"==typeof settings.data.strata&&(a.strata.stratas=settings.data.strata());var b=(a.strata.stratas[0].length,20);smx=b-1,smy=0;var c=a.settings.chart.width/a.settings.data.model.length,d=a.settings.sedimentation.aggregation.height,e=(a.token.colorRange,d3.svg.area().x(function(b){return a.settings.chart.spacer+b.x*(c-2*a.settings.chart.spacer)/smx}).y0(function(a){return d-a.y0*a.offshit}).y1(function(a){return d-(a.y+a.y0)*a.offshit})),f=a.strata.stratas.map(function(b,c){for(var d=0,e=0;d<b.length;d++)e+=b[d].value(a,c);return e}),g=d3.scale.linear().domain([0,Math.max(d3.max(f),a.settings.sedimentation.aggregation.maxData)]).range([0,a.settings.sedimentation.aggregation.height]),h=d3.select("#"+a.settings.DOMelement.id),i=h.selectAll("g.gcol");a.settings.sedimentation.aggregation.invertStrata&&i.transition().duration(100).attr("transform",function(b,d){var e=a.settings.sedimentation.aggregation.height;return e=2*a.settings.sedimentation.aggregation.height-g(f[d]),"translate("+d*c+", "+(a.settings.chart.height-(2*a.settings.sedimentation.aggregation.height-g(f[d])))+")"});i.selectAll("path").data(function(c,d){var e=d3.layout.stack().offset("expand")(a.strata.strata_layers(a,c.length,b,d));return smy=d3.max(e,function(a){return d3.max(a,function(a){return a.y0+a.y})}),e.map(function(a){a.map(function(a){return a.col=d,a})}),e});if("StackedAreaChart"==a.settings.chart.type){h.selectAll("path").transition().duration(100).attr("d",function(b,c){return a.settings.sedimentation.aggregation.invertStrata?(a.chartUpdate(c,-2*d+a.settings.chart.height),hh=g(f[b[0].col])):(a.chartUpdate(c,-g(f[c])-(d-a.settings.chart.height)),hh=a.settings.chart.height-a.chart.getPosition(a)[b[0].col].y),b.map(function(a){return a.offshit=hh,a}),e(b)})}}}}}(jQuery),function(a){a.fn._vs.flocculate={buffer:[],init:function(a){for(var b=0;b<a.settings.data.model.length;b++)this.buffer[b]=[]},addtobuffer:function(a,b){c=b.attr("category"),bufferSize=a.settings.sedimentation.flocculate.bufferSize,this.buffer[c].push(b),a.decay.tokens.splice(a.decay.tokens.indexOf(b),1),b.attr("callback","bufferFlocculation",b),this.buffer[c].length>bufferSize&&this.update(a,c,bufferSize)},destroyIt:function(a,b){b.attr("callback","flocculation",b),b.attr("state",2);var c=a.world.DestroyBody(b.myobj.GetBody());return c},update:function(a,b,c){if(1==a.settings.sedimentation.flocculate.number)for(;this.buffer[b].length>c;){var d=this.buffer[b].shift();this.destroyIt(a,d)}else for(;this.buffer[b].length>a.settings.sedimentation.flocculate.number;){var d=this.buffer[b].shift();this.destroyIt(a,d)}},disapear:function(a,b){window.setInterval(function(){b.update(self)},self.settings.options.refresh/2)},all:function(a){for(var b=a.decay.tokens-1;b>=0;b--)this.update(a,b,a.tokens.length)},strategy:function(){flocullateBuffer.length>0&&("Size"==chart.flocullate.strategy&&flocullateBuffer.length>=chart.flocullate.bufferSize?flocullateByArray(flocullateBuffer):"Time"==chart.flocullate.strategy||"Height"==chart.flocullate.strategy)}}}(jQuery),function(a){a.fn._vs.aggregate={defaultSettings:{},strata_layers:function(a,b,c,d){function e(a,b){return{x:b,y:Math.max(0,a)}}var f=d3.scale.linear().domain([1,c-2]).range([Math.PI/2,2*Math.PI-Math.PI/2]);d3.scale.pow().exponent(10).domain([0,c]).range([0,1]);return d3.range(b).map(function(b){var g=5*Math.random();return d3.range(c).map(function(c){if("sin"==a.settings.sedimentation.aggregation.strataType){if(1==b)return 20;var e=5+5*g*Math.sin(f(c))+50*b;return 0>e?-e:e}return"log"==a.settings.sedimentation.aggregation.strataType?b+1:("undefined"==typeof d&&(d=0),a.settings.data.strata[d][b].value)}).map(e)})},init:function(a){if("undefined"!=typeof a.settings.data.strata&&0!=a.settings.data.strata.length&&0!=a.settings.data.strata[0].length){var b=a.token.colorRange;if("StackedAreaChart"==a.settings.chart.type){var c=a.settings.chart.width/a.settings.data.model.length,d=a.settings.sedimentation.aggregation.height,e=d3.select("#"+a.settings.DOMelement.id).append("div").attr("class","vis").style("z-index",10).append("svg").attr("width",a.settings.width).attr("height",a.settings.height).append("g").attr("transform","translate("+a.settings.chart.x+","+a.settings.chart.y+")"),f=e.selectAll("g.gcol").data(a.settings.data.strata,function(a){return[a]}).enter().append("g").attr("transform",function(b,d){return"translate("+d*c+", "+(a.settings.chart.height-a.settings.sedimentation.aggregation.height)+")"}).attr("class",function(a,b){return"gcol col_"+b}),g=a.settings.data.strata.map(function(a){return{value:a[0].value}}),h=(a.settings.data.strata[0].length,20);smx=h-1,smy=0;var i=0,j=d3.svg.area().x(function(b){return a.settings.chart.spacer+b.x*(c-2*a.settings.chart.spacer)/smx}).y0(function(a){return d-a.y0*i}).y1(function(a){return d-(a.y+a.y0)*i}),k=f.selectAll("gpath").data(function(b,c){var d=d3.layout.stack().offset("expand")(a.aggregate.strata_layers(a,b.length,h,c));return smy=d3.max(d,function(a){return d3.max(a,function(a){return a.y0+a.y})}),d.map(function(a){a.map(function(a){return a.col=c,a})}),d}).enter().append("g").attr("class","gpath");k.append("path").attr("d",function(b,c){return i=a.settings.chart.height-a.chart.getPosition(a)[b[0].col].y,j(b)}).style("fill",function(c,d){return null!=a.settings.data.strata[c[0].col][d].texture?"url(#RectanglePattern_"+c[0].col+"_"+d+")":d3.rgb(b(c[0].col)).darker(a.settings.data.strata[c[0].col].length/2-(d+1)/2)}).attr("class",function(a,b){return"layer"}).attr("class",function(a,b){return"col_"+a[0].col+" layer_"+b});for(var l=c/1,m=l,n=0;n<a.settings.data.strata.length;n++)for(var o=0;o<a.settings.data.strata[n].length;o++)if(null!=a.settings.data.strata[n][o].texture){var p=e.append("pattern").attr("id","RectanglePattern_"+n+"_"+o).attr("height",m).attr("width",l).attr("patternTransform","translate(0, 0) scale("+a.settings.data.strata[n][o].texture.size+", "+a.settings.data.strata[n][o].texture.size+") rotate(0)").attr("patternUnits","userSpaceOnUse");p.append("image").attr("x",0).attr("y",0).attr("height",m).attr("width",l).attr("xlink:href",function(){return a.settings.data.strata[n][o].texture.url})}}else if("CircleLayout"==a.settings.chart.type){var q=d3.select("#"+a.settings.DOMelement.id).append("div").attr("class","vis").attr("width",a.settings.width).attr("height",a.settings.height).append("svg").attr("width",a.settings.width).attr("height",a.settings.height);if("undefined"!=typeof a.settings.chart.treeLayout)for(var r=0;r<a.settings.data.model.length;r++){var g=a.settings.data.strata[r],b=function(b){return a.token.colorRange(r)};a.aggregate.create_pie_chart(a,g,q,g[0].value,b,(r+.5)*a.settings.chart.width/a.settings.data.model.length+a.settings.chart.x,a.settings.chart.y+a.settings.chart.height/6)}else{var g=a.settings.data.strata.map(function(a){return{value:a[0].value}});console.log(a.settings.data.strata,g);var b=a.token.colorRange;a.aggregate.create_pie_chart(a,g,q,a.settings.chart.radius,b,a.settings.chart.x+a.settings.chart.width/2,a.settings.chart.y+a.settings.chart.height/2)}}}},create_pie_chart:function(a,b,c,d,e,f,g){var h=a.settings.width/a.settings.data.model.length,i=a.settings.sedimentation.aggregation.height;d3.scale.linear().domain([0,a.settings.data.strata.length-1]).range([0,a.settings.width]),d3.scale.linear().domain([0,d3.max(b,function(a){return a.value})]).rangeRound([0,i]),a.settings.width,a.settings.height,a.settings.sedimentation.aggregation.height;labelr=d+30,donut=d3.layout.pie().sort(null),arc=d3.svg.arc().innerRadius(0).outerRadius(d);var j=Math.random();c.append("g.arcs_"+j).attr("class","arcs_"+j);var k=c.selectAll(".arcs").data(donut(b.map(function(a,b){return a.value}))).enter().append("svg:g").attr("transform","translate("+f+","+g+")"),l=0;d3.svg.area().x(function(b){return a.settings.chart.spacer+b.x*(h-2*a.settings.chart.spacer)/smx}).y0(function(a){return i-a.y0*l}).y1(function(a){return i-(a.y+a.y0)*l}),k.append("path").attr("fill",function(a,b){return e(b)}).attr("d",function(a,b){return arc(a)}).each(function(a){this._current=a})},update:function(a){if("undefined"!=typeof a.settings.data.strata&&0!=a.settings.data.strata.length&&0!=a.settings.data.strata[0].length){var b=a.settings.chart.width/a.settings.data.model.length,c=a.settings.sedimentation.aggregation.height,d=(d3.scale.linear().domain([0,a.settings.data.strata.length-1]).range([0,a.settings.width]),a.settings.data.strata.map(function(a){return{value:a[0].value}}),a.settings.data.strata.map(function(a){for(var b=0,c=0;b<a.length;b++)c+=a[b].value;return c})),e=d3.scale.linear().domain([0,d3.max(d)]).range([0,a.settings.sedimentation.aggregation.height]),f=(a.settings.data.strata[0].length,20);smx=f-1,smy=0;var g=0,h=d3.svg.area().x(function(c){return a.settings.chart.spacer+c.x*(b-2*a.settings.chart.spacer)/smx}).y0(function(a){return c-a.y0*g}).y1(function(a){return c-(a.y+a.y0)*g}),i=d3.select("svg"),j=i.selectAll(".gcol");j.data(a.settings.data.strata,function(a,b){return[a]});var k=j.selectAll(".gpath").data(function(b,c){var d=d3.layout.stack().offset("expand")(a.aggregate.strata_layers(a,b.length,f,c));return smy=d3.max(d,function(a){return d3.max(a,function(a){return a.y0+a.y})}),d.map(function(a){a.map(function(a){return a.col=c,a})}),d});k.select("path").transition().duration(100).attr("d",function(b,f){return a.chartUpdate(f,-e(d[f])-(c-a.settings.chart.height)),g=a.settings.chart.height-a.chart.getPosition(a)[b[0].col].y,h(b)})}}}}(jQuery),function(a){a.fn._vs.chart.StackedAreaChart=function(a,b,c){if(this.init=function(a){gravity=new a.phy.b2Vec2(.001,10),a.world.m_gravity=gravity,a.chartPhySetup={grounds:[],wall:[]},this.setupChartPhysics(a)},this.setupChartPhysics=function(a){for(var b=a.settings.chart.spacer,c=a.settings.chart.width/a.settings.data.model.length,d=b,e=a.settings.chart.height/2+a.settings.chart.y,f=(a.settings.chart.height-a.settings.sedimentation.aggregation.height,0),g=0;g<a.settings.data.model.length;g++){if(a.settings.data.model[g].value=0,"undefined"!=typeof a.settings.data.strata&&"undefined"!=typeof a.settings.data.strata[g])for(var h=0;h<a.settings.data.strata[g].length;h++)a.settings.data.model[g].value+=a.settings.data.strata[g][h].value;f+=a.settings.data.model[g].value}for(var g=0;g<a.settings.data.model.length+1;g++){var i=a.settings.chart.x+g*c;a.chartPhySetup.wall[g]=this.createMyChartBox(a,i,e,d,a.settings.chart.height/2,"wall",a.settings.chart.wallColor),g<a.settings.data.model.length&&(a.settings.sedimentation.incoming.point[g]={x:i+c/2,y:a.settings.y}),g<a.settings.data.model.length&&(a.chartPhySetup.grounds[g]=this.createMyChartBox(a,i+c/2,a.settings.chart.height+a.settings.chart.y+a.settings.sedimentation.aggregation.height,c/2,a.settings.chart.height,"lift","rgba(250,250,250,0)"),this.update(a,{cat:g,y:a.settings.chart.height}))}},this.token=function(a,b){var c=b,d={x:a.settings.sedimentation.incoming.point[c].x+2*Math.random(),y:a.settings.sedimentation.incoming.point[c].y+1*Math.random(),t:a.now(),size:a.settings.sedimentation.token.size.original,category:c,lineWidth:0};return d},this.createMyChartBox=function(a,b,c,d,e,f,g){var h=a.settings.options.scale,i=new a.phy.b2FixtureDef;i.density=1,i.friction=.5,i.restitution=.2;var j=new a.phy.b2BodyDef;j.type=a.phy.b2Body.b2_staticBody,i.shape=new a.phy.b2PolygonShape,i.shape.SetAsBox(d/h,e/h),j.position.Set(b/h,c/h);var k=a.world.CreateBody(j).CreateFixture(i);return k.m_userData={type:f,fillStyle:g,w:d,h:e,x:b,y:c},k},this.update=function(a,b){if(null!=a.chartPhySetup.grounds[b.cat]){var c=a.chartPhySetup.grounds[b.cat].GetBody(),d=c.GetWorldCenter();d.y=(b.y+a.settings.chart.height+a.settings.chart.y+a.settings.sedimentation.aggregation.height)/a.settings.options.scale,c.SetPosition(d)}},this.getPositionOld=function(a){for(var b=[],c=0;c<a.chartPhySetup.grounds.length;c++)myElement=a.chartPhySetup.grounds[c],myBody=myElement.GetBody(),b.push({x:myBody.GetWorldCenter().x*a.settings.options.scale,y:myBody.GetWorldCenter().y*a.settings.options.scale,a:myBody.GetAngle(),w:myElement.m_userData.w,h:myElement.m_userData.h,r:myElement.m_userData.r});return b},this.getPosition=function(a){for(var b=[],c=0;c<a.chartPhySetup.grounds.length;c++)myElement=a.chartPhySetup.grounds[c],myBody=myElement.GetBody(),b.push({x:myBody.GetWorldCenter().x*a.settings.options.scale,y:myBody.GetWorldCenter().y*a.settings.options.scale-a.settings.chart.height-a.settings.chart.y,a:myBody.GetAngle(),w:myElement.m_userData.w,h:myElement.m_userData.h,r:myElement.m_userData.r});return b},void 0!=typeof b){var d=this[b](a,c);if(void 0!=typeof d)return d}}}(jQuery),function(b){b.fn._vs.chart.CircleLayout=function(b,d,e){function f(a,b,c,d){j=a*Math.PI/180;var e=Math.cos(j)*b+c,f=Math.sin(j)*b+d,g={x:e,y:f};return g}function g(a,c,d,e){var f=b.settings.options.scale,g=new b.phy.b2FixtureDef;g.density=1,g.friction=.5,g.restitution=.2;var h=new b.phy.b2BodyDef;g.shape=new b.phy.b2CircleShape(d/f),h.position.Set(a/f,c/f);var i=b.world.CreateBody(h).CreateFixture(g);return i.m_userData={type:"wall",familyID:null,fillStyle:e,strokeStyle:e,r:d},i}function h(a,c,d,e){console.log("CreatMyBubblePivot",a,c,d,e);var f=b.settings.options.scale,g=new b.phy.b2FixtureDef,h=d3.scale.category10();g.density=1e4,g.friction=0,g.restitution=0;var i=new b.phy.b2BodyDef;g.shape=new b.phy.b2CircleShape(d*f),i.position.Set(a/f,c/f);var j=b.world.CreateBody(i),k=j.CreateFixture(g);return console.log(e,h(e)),k.m_userData={type:"BubblePivot",familyID:e,fillStyle:b.settings.chart.wallColor},console.log(e,k),k.m_shape.m_radius=b.settings.data.model[e].value/f,k}var i,k,b,l=[],m=0;if(this.init=function(a,b){console.log("Circle Layout Init"),this._this=a,gravity=new a.phy.b2Vec2(0,0),a.world.m_gravity=gravity,a.chartPhySetup={grounds:[],wall:[]},this.treeLayout=a.settings.chart.treeLayout;for(var c=0;c<a.settings.data.model.length;c++)a.settings.data.strata[c][0].value=a.settings.data.strata[c][0].initValue;for(var c=0;c<a.settings.data.model.length;c++){a.settings.data.model[c].value=0;for(var d=0;d<a.settings.data.strata[c].length;d++)a.settings.data.model[c].value+=a.settings.data.strata[c][d].value;l.push(a.settings.data.model[c].value),m+=a.settings.data.model[c].value}this.treeLayout?(console.log("ici"),this.setupBubbleChartPhysics(a)):this.setupPieChartPhysics(a)},this.setupPieChartPhysics=function(b){console.log("w",b.settings.width);var d=b.settings.chart.radius;i=b.settings.chart.width/2+b.settings.chart.x,k=b.settings.chart.height/2+b.settings.chart.y;for(var e=(g(i,k,d,b.settings.chart.wallColor),0);e<b.settings.data.model.length;e++)b.settings.sedimentation.incoming.target[e]={x:i,y:k};var h=b.settings.chart.spacer,j=0;if(console.log("tdv",m),0==m){for(var e=0;e<b.settings.data.length;e++)l[e]=1;m=l.length}for(var e=0;e<l.length;e++)v=l[e],a2=(v/2+j)/m*360-90,j+=v,a=j/m*360-90,c=f(a2,5*d,i,k),console.log(c),b.settings.sedimentation.incoming.point[e]=c,b.chartPhySetup.grounds[e]=this.createBox(b,i,k,h,d,a,d,"wall",b.settings.chart.wallColor);console.log("w",b.settings.chart.width)},this.update=function(a,b){console.log("update");b.r-=90;var c=(b.r+90)*(Math.PI/180),d=f(b.r,a.settings.chart.radius,a.settings.chart.width/2+a.settings.chart.x,a.settings.chart.height/2+a.settings.chart.y);if(null!=a.chartPhySetup.grounds[b.cat]){var e=a.chartPhySetup.grounds[b.cat].GetBody(),g=e.GetWorldCenter(),h=e.GetAngle();g.y=d.y/a.settings.options.scale,g.x=d.x/a.settings.options.scale,h=c,e.SetPosition(g),e.SetAngle(h)}},this.token=function(a,b){var c=b,d={x:a.settings.sedimentation.incoming.point[c].x+2*Math.random(),y:a.settings.sedimentation.incoming.point[c].y+1*Math.random(),t:a.now(),size:a.settings.sedimentation.token.size.original,category:c,phy:{density:10,friction:0,restitution:0},targets:[{x:a.settings.sedimentation.incoming.target[c].x,y:a.settings.sedimentation.incoming.target[c].y}]};return d},this.createBox=function(a,b,c,d,e,g,h,i,j){var k=a.settings.options.scale,l=new a.phy.b2FixtureDef,m=f(g,h,b,c);l.density=1,l.friction=.5,l.restitution=.2;var n=new a.phy.b2BodyDef,o=(g+90)*(Math.PI/180);n.angle=o,n.type=a.phy.b2Body.b2_staticBody,l.shape=new a.phy.b2PolygonShape,l.shape.SetAsBox(d/k,e/k),n.position.Set(m.x/k,m.y/k);var p=a.world.CreateBody(n).CreateFixture(l);return p.m_userData={type:i,fillStyle:j,w:d,h:e,r:h},p},this.getPosition=function(a){for(var b=[],c=0;c<a.chartPhySetup.grounds.length;c++)myElement=a.chartPhySetup.grounds[c],myBody=myElement.GetBody(),b.push({x:myBody.GetWorldCenter().x*a.settings.options.scale,y:myBody.GetWorldCenter().y*a.settings.options.scale,a:myBody.GetAngle(),w:myElement.m_userData.w,h:myElement.m_userData.h,r:myElement.m_userData.r});return b},this.setupBubbleChartPhysics=function(a){console.log("setupBubbleChartPhysics");for(var b=(a.settings.chart.width/a.settings.data.model.length,a.settings.chart.spacer),c=(a.settings.chart.height/2+a.settings.y+b,0),d=0,e=a.settings.chart.column,f=0;f<a.settings.data.model.length;f++)d=a.settings.chart.x+f%e*b+b/2,c=a.settings.chart.y+Math.floor(f/e)*b+b/2,a.settings.sedimentation.incoming.target[f]={x:d,y:c},g[f]=h(d,c,a.settings.chart.spacer,f),a.settings.data.model[f].incomingPoint={x:d,y:c}},this.getPivotPosition=function(a){if("undefined"!=typeof a)return this.pivot;for(var c=[],d=0;d<b.settings.data.model.length;d++)c.push(b.settings.data.model[d]);return c},void 0!=typeof d){var n=this[d](b,e);if(void 0!=typeof n)return n}}}(jQuery);
